const ul=document.querySelector(".main>ul"),lis=ul.getElementsByTagName("li"),rem=ul.getElementsByClassName("removeTopic"),collectionTitle=document.querySelector(".collectionTitle"),collector=document.querySelector(".collector"),deadline=document.querySelector(".deadline"),description=document.querySelector(".description"),op_name=document.getElementById("op-name"),op_file=document.getElementById("op-file"),op_sno=document.getElementById("op-sno"),op_radio=document.getElementById("op-radio"),op_multipleChoice=document.getElementById("op-multipleChoice"),op_qnaire=document.getElementById("op-qnaire"),btn_for_add=document.querySelector("#btn-for-add"),popup=document.querySelector(".popup"),myalert=document.querySelector(".alert"),myblur=document.querySelector("#blur"),cancel=document.querySelector(".popup-header>span"),btn_for_submit=document.getElementById("btn-for-submit"),form=document.getElementById("form");let dragElement=null,qnum=1,question_id=0,countdown=2;function addLoadEvent(e){var t=window.onload;"function"!=typeof window.onload?window.onload=e:window.onload=function(){t(),e()}}function getCurrentDatetime(){var e=new Date,t=e.getFullYear(),l=e.getMonth()+1,n=e.getDate(),a=e.getHours(),i=e.getMinutes(),d=e.getSeconds(),o=t+"-";return l<10&&(o+="0"),o+=l+"-",n<10&&(o+="0"),o+=n+"T",a<10&&(o+="0"),o+=a+":",i<10&&(o+="0"),o+=i+":",d<10&&(o+="0"),o+=d}function deadline_limit(){let e=getCurrentDatetime();deadline.min=e,deadline.max="2050-12-31T23:59:59"}function createName(e,t){let l=document.createElement("li"),n=document.createElement("h1"),a=document.createElement("input");a.className="input-topic",a.required="required",l.id=(++question_id).toString(),a.name="question_name",a.type="text",a.value=e,a.maxLength="20",a.placeholder="添加题目名称";let i=document.createElement("textarea");i.placeholder="添加详情描述",i.name="detail",i.value=t;let d=document.createElement("input");d.className="input-content",d.type="text",d.disabled="disabled",d.placeholder="此项由提交者填写";let o=document.createElement("button");o.className="removeTopic",o.style.display="none",o.appendChild(document.createTextNode("删除题目")),n.appendChild(a),l.appendChild(n),l.appendChild(i),l.appendChild(d),l.appendChild(o),ul.appendChild(l),cancel.onclick(),for_checkbox("add",l.id,a.value),o.addEventListener("click",()=>{for_checkbox("remove",l.id,a.value),ul.removeChild(l)}),a.onchange=()=>{for_checkbox("modify",l.id,a.value)}}function createSno(e,t){let l=document.createElement("li"),n=document.createElement("h1"),a=document.createElement("input");a.className="input-topic",a.required="required",l.id=(++question_id).toString(),a.name="question_sno",a.type="text",a.value=e,a.maxLength="20",a.placeholder="添加题目名称";let i=document.createElement("textarea");i.placeholder="添加详情描述",i.name="detail",i.value=t;let d=document.createElement("input");d.className="input-content",d.type="text",d.disabled="disabled",d.placeholder="此项由提交者填写";let o=document.createElement("button");o.className="removeTopic",o.style.display="none",o.appendChild(document.createTextNode("删除题目")),n.appendChild(a),l.appendChild(n),l.appendChild(i),l.appendChild(d),l.appendChild(o),ul.appendChild(l),for_checkbox("add",l.id,a.value),cancel.onclick(),o.addEventListener("click",()=>{for_checkbox("remove",l.id,a.value),ul.removeChild(l)}),a.onchange=()=>{for_checkbox("modify",l.id,a.value)}}function createFile(e,t){let l=document.createElement("li"),n=document.createElement("h1"),a=document.createElement("input");a.className="input-topic",a.required="required",l.id=(++question_id).toString(),a.name="question_file",a.type="text",a.value=e,a.maxLength="20",a.placeholder="添加题目名称";let i=document.createElement("textarea");i.placeholder="添加详情描述",i.name="detail",i.value=t;let d=document.createElement("span");d.className="nameRules",d.setAttribute("data-hint","提交的文件将按照勾选的选项自动重命名"),d.appendChild(document.createTextNode("重命名规则："));let o=document.createElement("div");o.className="selectTopic";let r=document.createElement("input");r.className="input-content",r.disabled="disabled",r.type="file";let c=document.createElement("button");c.className="removeTopic",c.style.display="none",c.appendChild(document.createTextNode("删除题目")),n.appendChild(a),l.appendChild(n),l.appendChild(i),l.appendChild(d),updateCheckbox(o),l.appendChild(o),l.appendChild(r),l.appendChild(c),ul.appendChild(l),cancel.onclick(),c.addEventListener("click",()=>{ul.removeChild(l)})}function updateCheckbox(e){for(let t=0;t<lis.length;t++){let l=lis[t].getElementsByClassName("input-topic")[0],n=lis[t].getElementsByClassName("input-content")[0];if(!n||"file"===n.type)continue;let a=document.createElement("input"),i=document.createElement("span");i.className="checked_topic_text",a.type="checkbox",a.id=lis[t].id,a.name="checked_topic",a.value=l.value,i.appendChild(document.createTextNode(l.value)),e.appendChild(a),e.appendChild(i)}}function for_checkbox(e,t,l){for(let n=0;n<lis.length;n++){let a=lis[n].getElementsByClassName("input-content")[0];if(a&&"file"===a.type){let i=lis[n].getElementsByClassName("selectTopic")[0];if(i.children.length,"add"===e){let d=document.createElement("input"),o=document.createElement("span");d.type="checkbox",d.id=t,d.name="checked_topic",d.value=l,o.appendChild(document.createTextNode(l)),i.appendChild(d),i.appendChild(o)}else if("remove"===e)for(let r=0;r<i.children.length;r++)i.children[r].id&&i.children[r].id===t&&(i.removeChild(i.children[r].nextSibling),i.removeChild(i.children[r]));else if("modify"===e)for(let c=0;c<i.children.length;c++)i.children[c].id&&i.children[c].id===t&&(i.children[c].nextSibling.innerHTML=l,i.children[c].value=l);else{let p=null,s=null,m=null;for(let h=0;h<i.children.length;h++)i.children[h].id&&i.children[h].id===t?(p=i.children[h],m=i.children[h].nextSibling):i.children[h].id&&i.children[h].id===l&&(s=i.children[h]);if(0===l){i.appendChild(p),i.appendChild(m);return}i.insertBefore(m,s),i.insertBefore(p,m)}}}}function createSingleChoice(e,t,l,n){let a=document.createElement("li"),i=document.createElement("h1"),d=document.createElement("input");d.className="input-topic",d.required="required",a.id=(++question_id).toString(),d.name="question_radio",d.type="text",d.value=e,d.maxLength="20",d.placeholder="添加题目名称";let o=document.createElement("textarea");o.placeholder="添加详情描述",o.name="detail",o.value=t;let r=document.createElement("button");r.className="removeTopic",r.style.display="none",r.appendChild(document.createTextNode("删除题目")),i.appendChild(d),a.appendChild(i),a.appendChild(o);let c=addChoice_for_fileEditing(0,l,n);a.appendChild(c),a.appendChild(r),ul.appendChild(a),cancel.onclick(),r.addEventListener("click",()=>{ul.removeChild(a)})}function addChoice_for_fileEditing(e,t,l){let n=document.createElement("div");n.className="questionBox1";let a=["A","B","C","D"];for(let i=0;i<4;i++){let d=document.createElement("input");d.type=0===e?"radio":"checkbox",d.name=qnum.toString(),d.value=a[i],0===e&&(d.required="required");let o=document.createElement("span");o.appendChild(document.createTextNode(a[i])),n.appendChild(d),n.appendChild(o)}for(let r=0;r<l.length;r++)n.children[2*l[r]].checked="true";return qnum++,n}function createMultipleChoice(e,t,l,n){let a=document.createElement("li"),i=document.createElement("h1"),d=document.createElement("input");d.className="input-topic",d.required="required",a.id=(++question_id).toString(),d.name="question_multipleChoice",d.type="text",d.value=e,d.maxLength="20",d.placeholder="添加题目名称";let o=document.createElement("textarea");o.placeholder="添加详情描述",o.name="detail",o.value=t;let r=document.createElement("button");r.className="removeTopic",r.style.display="none",r.appendChild(document.createTextNode("删除题目")),i.appendChild(d),a.appendChild(i),a.appendChild(o);let c=addChoice_for_fileEditing(1,l,n);a.appendChild(c),a.appendChild(r),ul.appendChild(a),cancel.onclick(),r.addEventListener("click",()=>{ul.removeChild(a)})}function numberQuestion(){let e=1;for(let t=0;t<lis.length;t++){let l=lis[t].getElementsByClassName("input-topic")[0];lis[t].id=""+e,l.name=l.name+e;let n=lis[t].getElementsByTagName("textarea")[0];n.name=n.name+e;let a=lis[t].getElementsByClassName("selectTopic")[0];if(a){let i=a.children;for(let d=0;d<i.length;d++)i[d].name&&(i[d].name=i[d].name+e)}let o=lis[t].getElementsByClassName("questionBox1")[0];if(o&&"radio"==o.children[0].type){let r=o.children;for(let c=0;c<r.length;c++)r[c].name&&(r[c].name="checked_radio"+e)}let p=lis[t].getElementsByClassName("questionBox1")[0];if(p&&"checkbox"==p.children[0].type){let s=p.children;for(let m=0;m<s.length;m++)s[m].name&&(s[m].name="checked_mulans"+e)}let h=lis[t].getElementsByClassName("qnaire_textarea");if(h)for(let u=0;u<h.length;u++)h[u].name&&(h[u].name=h[u].name+e);let f=lis[t].querySelectorAll(".hidden_radio");if(f)for(let C=0;C<f.length;C++)f[C].name="choose_type"+e;e++}return!0}function createQuestionnaire(e,t,l,n){let a=document.createElement("li"),i=document.createElement("h1"),d=document.createElement("input");d.className="input-topic",a.id=(++question_id).toString(),d.name="question_qnaire",d.type="text",d.value=e,d.maxLength="20",d.placeholder="添加题目名称";let o=document.createElement("textarea");o.placeholder="添加详情描述",o.name="detail",o.value=t;let r=document.createElement("div");r.className="questionBox";let c=document.createElement("button");c.className="removeTopic",c.style.display="none",c.appendChild(document.createTextNode("删除题目"));let p=document.createElement("div");p.className="qnaire_addop",p.appendChild(document.createTextNode("添加选项"));let s=document.createElement("div");s.className="if_multi";let m=document.createElement("input");m.type="checkbox";let h=document.createElement("label");h.appendChild(document.createTextNode("多选"));let u=document.createElement("input"),f=document.createElement("input");u.type="radio",f.type="radio",u.className="hidden hidden_radio",f.className="hidden hidden_radio",u.value="single",f.value="multiple",u.name="choose_type"+a.id,f.name="choose_type"+a.id,u.checked="checked",i.appendChild(d),a.appendChild(i),a.appendChild(o),a.appendChild(r),a.appendChild(p),s.appendChild(m),s.appendChild(h),s.appendChild(u),s.appendChild(f),a.appendChild(s),a.appendChild(c),ul.appendChild(a),cancel.onclick(),c.addEventListener("click",()=>{ul.removeChild(a)}),p.onclick=()=>{r.appendChild(addQuestion(m.checked))},n&&(m.checked=!0,u.removeAttribute("checked"),f.checked="checked");for(let C=0;C<l.length;C++)r.appendChild(addQuestion_for_fileEditing(m.checked,l[C]));m.onchange=()=>{let e=a.getElementsByClassName("qnaire_check");if(m.checked){for(let t=0;t<e.length;t++)e[t].type="checkbox";u.removeAttribute("checked"),f.checked="checked"}else{for(let l=0;l<e.length;l++)e[l].type="radio";f.removeAttribute("checked"),u.checked="checked"}}}function addQuestion(e){let t=document.createElement("div");t.className="qnaire_option";let l=document.createElement("input");!1==e?l.type="radio":l.type="checkbox",l.className="qnaire_check",l.disabled="disabled";let n=document.createElement("textarea");n.className="qnaire_textarea",n.placeholder="请输入选项的内容",n.name="qn_option";let a=document.createElement("span");return a.className="qnaire_removeop",t.appendChild(l),t.appendChild(n),t.appendChild(a),a.onclick=()=>{t.parentNode.removeChild(t)},n.addEventListener("input",()=>{n.style.height="auto",n.style.height=n.scrollHeight+"px"}),t}function addQuestion_for_fileEditing(e,t){let l=document.createElement("div");l.className="qnaire_option";let n=document.createElement("input");!1==e?n.type="radio":n.type="checkbox",n.className="qnaire_check",n.disabled="disabled";let a=document.createElement("textarea");a.className="qnaire_textarea",a.placeholder="请输入选项的内容",a.name="qn_option",a.value=t;let i=document.createElement("span");return i.className="qnaire_removeop",l.appendChild(n),l.appendChild(a),l.appendChild(i),i.onclick=()=>{l.parentNode.removeChild(l)},a.addEventListener("input",()=>{a.style.height="auto",a.style.height=a.scrollHeight+"px"}),l}function check(){let e=0,t=getCurrentDatetime();console.log(t),console.log(deadline.value),t>=deadline.value&&(e=6);let l=[],n=document.getElementsByClassName("input-topic");for(let a=0;a<n.length;a++)-1==l.indexOf(n[a].value)?l.push(n[a].value):e=1;for(let i=0;i<n.length;i++){if("question_multipleChoice"!=n[i].name)continue;let d=lis[i].querySelectorAll("input[type='checkbox']"),o=0;for(let r=0;r<d.length;r++)d[r].checked&&o++;o<2&&(e=2)}for(let c=0;c<n.length;c++){if("question_qnaire"!=n[c].name)continue;let p=lis[c].querySelectorAll(".qnaire_option"),s=lis[c].querySelectorAll(".qnaire_textarea");if(p.length<2)e=3;else for(let m=0;m<s.length;m++)""==s[m].value&&(e=4)}if(0===n.length&&(e=5),e){let h=myalert.getElementsByTagName("h1")[0];return 1===e?h.innerHTML="不能有重复标题!":2===e?h.innerHTML="多选题请至少选择两个选项!":3===e?h.innerHTML="问卷选项不能少于两个！":4===e?h.innerHTML="问卷选项内容不能为空！":5===e?h.innerHTML="至少有一个题目！":6===e&&(h.innerHTML="截止时间不能早于当前时间！"),myalert.style.display="block",myblur.style.display="block",countdown=2,timeOutClose(),!1}return!0}function timeOutClose(){countdown>0?setTimeout("timeOutClose();",1e3):(myalert.style.display="none",myblur.style.display="none"),countdown--}btn_for_add.onclick=()=>{popup.style.display="block",myblur.style.display="block"},cancel.onclick=()=>{popup.style.display="none",myblur.style.display="none"},form.onsubmit=()=>!!check()&&numberQuestion(),op_name.onclick=()=>{createName("姓名","")},op_sno.onclick=()=>{createSno("学号","")},op_file.onclick=()=>{createFile("文件","")},op_radio.onclick=()=>{createSingleChoice("单选题","",0,[])},op_multipleChoice.onclick=()=>{createMultipleChoice("多选题","",0,[])},op_qnaire.onclick=()=>{createQuestionnaire("问卷题目","",["",""],!1)};let tmp_json=document.getElementById("collection").innerHTML;tmp_json=eval("("+tmp_json+")");let formData=JSON.parse(JSON.stringify(tmp_json)),formDataArr=[],formDataObj={},formDataLen=0;const reg=/(\d+)$/;let lastNum=1;function processFormData(){for(item in formData){let e=reg.exec(item);if(e){let t=e[1];t!=lastNum&&(formDataArr.push(formDataObj),formDataObj={});let l=item,n=formData[item];formDataObj[l]=n,lastNum=t}}formDataArr.push(formDataObj),formDataLen=formDataArr.length}function createQuestion(){collectionTitle.value=Object.values(formData)[0],collector.value=Object.values(formData)[1],deadline.value=Object.values(formData)[2].replace(" ","T"),description.value=Object.values(formData)[3];for(let e=0;e<formDataLen;e++){formDataArr[e];let t=Object.keys(formDataArr[e]),l=Object.values(formDataArr[e]);if(-1!=t[0].indexOf("question_name"))createName(l[0],l[1]);else if(-1!=t[0].indexOf("question_sno"))createSno(l[0],l[1]);else if(-1!=t[0].indexOf("question_file"))createFile(l[0],l[1]);else if(-1!=t[0].indexOf("question_radio")){let n=l[l.length-1].toString().charCodeAt()-"A".charCodeAt();createSingleChoice(l[0],l[1],1,[n])}else if(-1!=t[0].indexOf("question_multipleChoice")){let a=0,i=[];for(let d=0;d<t.length;d++)-1!=t[d].indexOf("checked_mulans")&&(a++,i.push(l[d].toString().charCodeAt()-"A".charCodeAt()));createMultipleChoice(l[0],l[1],a,i)}else{let o=0,r=[];for(let c=0;c<t.length;c++)-1!=t[c].indexOf("qn_option")&&(o++,r.push(l[c]));let p="multiple"==l[l.length-1];createQuestionnaire(l[0],l[1],r,p)}}for(let s=0;s<formDataLen;s++){formDataArr[s];let m=Object.keys(formDataArr[s]),h=Object.values(formDataArr[s]),u=lis[s].querySelectorAll(".checked_topic_text");if(-1!=m[0].indexOf("question_file")){for(let f=0;f<m.length;f++)if(-1!=m[f].indexOf("checked_topic"))for(let C=0;C<u.length;C++)u[C].innerHTML==h[f]&&(u[C].previousSibling.checked="chekced")}}}addLoadEvent(processFormData),addLoadEvent(createQuestion),addLoadEvent(deadline_limit);