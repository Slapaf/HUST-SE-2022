const ul=document.querySelector(".main>ul"),lis=ul.getElementsByTagName("li"),rem=ul.getElementsByClassName("removeTopic"),collectionTitle=document.querySelector(".collectionTitle"),collector=document.querySelector(".collector"),deadline=document.querySelector(".deadline"),description=document.querySelector(".description"),op_name=document.getElementById("op-name"),op_file=document.getElementById("op-file"),op_sno=document.getElementById("op-sno"),op_radio=document.getElementById("op-radio"),op_multipleChoice=document.getElementById("op-multipleChoice"),op_qnaire=document.getElementById("op-qnaire"),btn_for_add=document.querySelector("#btn-for-add"),popup=document.querySelector(".popup"),myalert=document.querySelector(".alert"),myblur=document.querySelector("#blur"),cancel=document.querySelector(".popup-header>span"),btn_for_submit=document.getElementById("btn-for-submit"),form=document.getElementById("form");let dragElement=null,qnum=1,question_id=0,countdown=2;function addLoadEvent(e){var t=window.onload;"function"!=typeof window.onload?window.onload=e:window.onload=function(){t(),e()}}function getCurrentDatetime(){var e=new Date,t=e.getFullYear(),l=e.getMonth()+1,n=e.getDate(),a=e.getHours(),i=e.getMinutes(),r=e.getSeconds(),o=t+"-";return l<10&&(o+="0"),o+=l+"-",n<10&&(o+="0"),o+=n+"T",a<10&&(o+="0"),o+=a+":",i<10&&(o+="0"),o+=i+":",r<10&&(o+="0"),o+=r}function deadline_limit(){let e=getCurrentDatetime();deadline.min=e,deadline.max="2050-12-31T23:59:59"}function createName(e,t){let l=document.createElement("li"),n=document.createElement("h1"),a=document.createElement("input");a.className="input-topic",a.required="required",l.id=(++question_id).toString(),a.name="question_name",a.type="text",a.value=e,a.maxLength="20",a.placeholder="添加题目名称";let i=document.createElement("textarea");i.placeholder="添加详情描述",i.name="detail",i.value=t;let r=document.createElement("input");r.className="input-content",r.type="text",r.disabled="disabled",r.placeholder="此项由提交者填写";let o=document.createElement("button");o.className="removeTopic",o.appendChild(document.createTextNode("删除题目")),n.appendChild(a),l.appendChild(n),l.appendChild(i),l.appendChild(r),l.appendChild(o),ul.appendChild(l),cancel.onclick(),for_checkbox("add",l.id,a.value),o.addEventListener("click",()=>{for_checkbox("remove",l.id,a.value),ul.removeChild(l)}),a.onchange=()=>{for_checkbox("modify",l.id,a.value)},l.draggable="true",l.ondragstart=onDragStart,l.ondragover=onDragOver,l.ondrop=onDrop}function createSno(e,t){let l=document.createElement("li"),n=document.createElement("h1"),a=document.createElement("input");a.className="input-topic",a.required="required",l.id=(++question_id).toString(),a.name="question_sno",a.type="text",a.value=e,a.maxLength="20",a.placeholder="添加题目名称";let i=document.createElement("textarea");i.placeholder="添加详情描述",i.name="detail",i.value=t;let r=document.createElement("input");r.className="input-content",r.type="text",r.disabled="disabled",r.placeholder="此项由提交者填写";let o=document.createElement("button");o.className="removeTopic",o.appendChild(document.createTextNode("删除题目")),n.appendChild(a),l.appendChild(n),l.appendChild(i),l.appendChild(r),l.appendChild(o),ul.appendChild(l),for_checkbox("add",l.id,a.value),cancel.onclick(),o.addEventListener("click",()=>{for_checkbox("remove",l.id,a.value),ul.removeChild(l)}),a.onchange=()=>{for_checkbox("modify",l.id,a.value)},l.draggable="true",l.ondragstart=onDragStart,l.ondragover=onDragOver,l.ondrop=onDrop}function createFile(e,t){let l=document.createElement("li"),n=document.createElement("h1"),a=document.createElement("input");a.className="input-topic",a.required="required",l.id=(++question_id).toString(),a.name="question_file",a.type="text",a.value=e,a.maxLength="20",a.placeholder="添加题目名称";let i=document.createElement("textarea");i.placeholder="添加详情描述",i.name="detail",i.value=t;let r=document.createElement("span");r.className="nameRules",r.setAttribute("data-hint","提交的文件将按照勾选的选项自动重命名"),r.appendChild(document.createTextNode("重命名规则："));let o=document.createElement("div");o.className="selectTopic";let d=document.createElement("input");d.className="input-content",d.disabled="disabled",d.type="file";let c=document.createElement("button");c.className="removeTopic",c.appendChild(document.createTextNode("删除题目")),n.appendChild(a),l.appendChild(n),l.appendChild(i),l.appendChild(r),updateCheckbox(o),l.appendChild(o),l.appendChild(d),l.appendChild(c),ul.appendChild(l),cancel.onclick(),c.addEventListener("click",()=>{ul.removeChild(l)}),l.draggable="true",l.ondragstart=onDragStart,l.ondragover=onDragOver,l.ondrop=onDrop}function updateCheckbox(e){for(let t=0;t<lis.length;t++){let l=lis[t].getElementsByClassName("input-topic")[0],n=lis[t].getElementsByClassName("input-content")[0];if(!n||"file"===n.type)continue;let a=document.createElement("input"),i=document.createElement("span");i.className="checked_topic_text",a.type="checkbox",a.id=lis[t].id,a.name="checked_topic",a.value=l.value,i.appendChild(document.createTextNode(l.value)),e.appendChild(a),e.appendChild(i)}}function for_checkbox(e,t,l){for(let n=0;n<lis.length;n++){let a=lis[n].getElementsByClassName("input-content")[0];if(a&&"file"===a.type){let i=lis[n].getElementsByClassName("selectTopic")[0];if(i.children.length,"add"===e){let r=document.createElement("input"),o=document.createElement("span");r.type="checkbox",r.id=t,r.name="checked_topic",r.value=l,o.appendChild(document.createTextNode(l)),i.appendChild(r),i.appendChild(o)}else if("remove"===e)for(let d=0;d<i.children.length;d++)i.children[d].id&&i.children[d].id===t&&(i.removeChild(i.children[d].nextSibling),i.removeChild(i.children[d]));else if("modify"===e)for(let c=0;c<i.children.length;c++)i.children[c].id&&i.children[c].id===t&&(i.children[c].nextSibling.innerHTML=l,i.children[c].value=l);else{let p=null,s=null,m=null;for(let u=0;u<i.children.length;u++)i.children[u].id&&i.children[u].id===t?(p=i.children[u],m=i.children[u].nextSibling):i.children[u].id&&i.children[u].id===l&&(s=i.children[u]);if(0===l){i.appendChild(p),i.appendChild(m);return}i.insertBefore(m,s),i.insertBefore(p,m)}}}}function createSingleChoice(e,t,l,n){let a=document.createElement("li"),i=document.createElement("h1"),r=document.createElement("input");r.className="input-topic",r.required="required",a.id=(++question_id).toString(),r.name="question_radio",r.type="text",r.value=e,r.maxLength="20",r.placeholder="添加题目名称";let o=document.createElement("textarea");o.placeholder="添加详情描述",o.name="detail",o.value=t;let d=document.createElement("button");d.className="removeTopic",d.appendChild(document.createTextNode("删除题目")),i.appendChild(r),a.appendChild(i),a.appendChild(o);let c=addChoice_for_fileEditing(0,l,n);a.appendChild(c),a.appendChild(d),ul.appendChild(a),cancel.onclick(),d.addEventListener("click",()=>{ul.removeChild(a)}),a.draggable="true",a.ondragstart=onDragStart,a.ondragover=onDragOver,a.ondrop=onDrop}function addChoice_for_fileEditing(e,t,l){let n=document.createElement("div");n.className="questionBox1";let a=["A","B","C","D"];for(let i=0;i<4;i++){let r=document.createElement("input");r.type=0===e?"radio":"checkbox",r.name=qnum.toString(),r.value=a[i],0===e&&(r.required="required");let o=document.createElement("span");o.appendChild(document.createTextNode(a[i])),n.appendChild(r),n.appendChild(o)}for(let d=0;d<l.length;d++)n.children[2*l[d]].checked="true";return qnum++,n}function createMultipleChoice(e,t,l,n){let a=document.createElement("li"),i=document.createElement("h1"),r=document.createElement("input");r.className="input-topic",r.required="required",a.id=(++question_id).toString(),r.name="question_multipleChoice",r.type="text",r.value=e,r.maxLength="20",r.placeholder="添加题目名称";let o=document.createElement("textarea");o.placeholder="添加详情描述",o.name="detail",o.value=t;let d=document.createElement("button");d.className="removeTopic",d.appendChild(document.createTextNode("删除题目")),i.appendChild(r),a.appendChild(i),a.appendChild(o);let c=addChoice_for_fileEditing(1,l,n);a.appendChild(c),a.appendChild(d),ul.appendChild(a),cancel.onclick(),d.addEventListener("click",()=>{ul.removeChild(a)}),a.draggable="true",a.ondragstart=onDragStart,a.ondragover=onDragOver,a.ondrop=onDrop}function onDragStart(e){dragElement=e.currentTarget}function onDragOver(e){e.preventDefault()}function onDrop(e){let t=e.currentTarget;if(dragElement===t)return;let l=dragElement.id,n=t.id,a=dragElement.getElementsByClassName("input-topic")[0].name,i=t.getElementsByClassName("input-topic")[0].name;if("question_name"===a||"question_sno"===a){if("question_name"===i||"question_sno"===i)dragElement.nextSibling===t?for_checkbox("swap",n,l):for_checkbox("swap",l,n);else{let r=t.nextSibling,o=null,d=0;for(;r;){if((o=r.getElementsByClassName("input-topic")[0].name)&&("question_name"===o||"question_sno"===o)){for_checkbox("swap",l,r.id),d=1;break}r=r.nextSibling}d||for_checkbox("swap",l,0)}}null!=dragElement&&(dragElement.nextSibling===t?ul.insertBefore(t,dragElement):ul.insertBefore(dragElement,t))}function numberQuestion(){let e=1;for(let t=0;t<lis.length;t++){let l=lis[t].getElementsByClassName("input-topic")[0];lis[t].id=""+e,l.name=l.name+e;let n=lis[t].getElementsByTagName("textarea")[0];n.name=n.name+e;let a=lis[t].getElementsByClassName("selectTopic")[0];if(a){let i=a.children;for(let r=0;r<i.length;r++)i[r].name&&(i[r].name=i[r].name+e)}let o=lis[t].getElementsByClassName("questionBox1")[0];if(o&&"radio"==o.children[0].type){let d=o.children;for(let c=0;c<d.length;c++)d[c].name&&(d[c].name="checked_radio"+e)}let p=lis[t].getElementsByClassName("questionBox1")[0];if(p&&"checkbox"==p.children[0].type){let s=p.children;for(let m=0;m<s.length;m++)s[m].name&&(s[m].name="checked_mulans"+e)}let u=lis[t].getElementsByClassName("qnaire_textarea");if(u)for(let h=0;h<u.length;h++)u[h].name&&(u[h].name=u[h].name+e);let f=lis[t].querySelectorAll(".hidden_radio");if(f){console.log(f.length);for(let g=0;g<f.length;g++)f[g].name="choose_type"+e}e++}return!0}function createQuestionnaire(e,t,l,n){let a=document.createElement("li"),i=document.createElement("h1"),r=document.createElement("input");r.className="input-topic",a.id=(++question_id).toString(),r.name="question_qnaire",r.type="text",r.value=e,r.maxLength="20",r.placeholder="添加题目名称";let o=document.createElement("textarea");o.placeholder="添加详情描述",o.name="detail",o.value=t;let d=document.createElement("div");d.className="questionBox";let c=document.createElement("button");c.className="removeTopic",c.appendChild(document.createTextNode("删除题目"));let p=document.createElement("div");p.className="qnaire_addop",p.appendChild(document.createTextNode("添加选项"));let s=document.createElement("div");s.className="if_multi";let m=document.createElement("input");m.type="checkbox";let u=document.createElement("label");u.appendChild(document.createTextNode("多选"));let h=document.createElement("input"),f=document.createElement("input");h.type="radio",f.type="radio",h.className="hidden hidden_radio",f.className="hidden hidden_radio",h.value="single",f.value="multiple",h.name="choose_type"+a.id,f.name="choose_type"+a.id,h.checked="checked",i.appendChild(r),a.appendChild(i),a.appendChild(o),a.appendChild(d),a.appendChild(p),s.appendChild(m),s.appendChild(u),s.appendChild(h),s.appendChild(f),a.appendChild(s),a.appendChild(c),ul.appendChild(a),cancel.onclick(),c.addEventListener("click",()=>{ul.removeChild(a)}),p.onclick=()=>{d.appendChild(addQuestion(m.checked))},n&&(m.checked=!0,h.removeAttribute("checked"),f.checked="checked");for(let g=0;g<l.length;g++)d.appendChild(addQuestion_for_fileEditing(m.checked,l[g]));m.onchange=()=>{let e=a.getElementsByClassName("qnaire_check");if(m.checked){for(let t=0;t<e.length;t++)e[t].type="checkbox";h.removeAttribute("checked"),f.checked="checked"}else{for(let l=0;l<e.length;l++)e[l].type="radio";f.removeAttribute("checked"),h.checked="checked"}},a.draggable="true",a.ondragstart=onDragStart,a.ondragover=onDragOver,a.ondrop=onDrop}function addQuestion(e){let t=document.createElement("div");t.className="qnaire_option";let l=document.createElement("input");!1==e?l.type="radio":l.type="checkbox",l.className="qnaire_check",l.disabled="disabled";let n=document.createElement("textarea");n.className="qnaire_textarea",n.placeholder="请输入选项的内容",n.name="qn_option";let a=document.createElement("span");return a.className="qnaire_removeop",t.appendChild(l),t.appendChild(n),t.appendChild(a),a.onclick=()=>{t.parentNode.removeChild(t)},n.addEventListener("input",()=>{n.style.height="auto",n.style.height=n.scrollHeight+"px"}),t}function addQuestion_for_fileEditing(e,t){let l=document.createElement("div");l.className="qnaire_option";let n=document.createElement("input");!1==e?n.type="radio":n.type="checkbox",n.className="qnaire_check",n.disabled="disabled";let a=document.createElement("textarea");a.className="qnaire_textarea",a.placeholder="请输入选项的内容",a.name="qn_option",a.value=t;let i=document.createElement("span");return i.className="qnaire_removeop",l.appendChild(n),l.appendChild(a),l.appendChild(i),i.onclick=()=>{l.parentNode.removeChild(l)},a.addEventListener("input",()=>{a.style.height="auto",a.style.height=a.scrollHeight+"px"}),l}function check(){let e=0;getCurrentDatetime()>=deadline.value&&(e=6);let t=[],l=document.getElementsByClassName("input-topic");for(let n=0;n<l.length;n++)-1==t.indexOf(l[n].value)?t.push(l[n].value):e=1;for(let a=0;a<l.length;a++){if("question_multipleChoice"!=l[a].name)continue;let i=lis[a].querySelectorAll("input[type='checkbox']"),r=0;for(let o=0;o<i.length;o++)i[o].checked&&r++;r<2&&(e=2)}for(let d=0;d<l.length;d++){if("question_qnaire"!=l[d].name)continue;let c=lis[d].querySelectorAll(".qnaire_option"),p=lis[d].querySelectorAll(".qnaire_textarea");if(c.length<2)e=3;else for(let s=0;s<p.length;s++)""==p[s].value&&(e=4)}if(0===l.length&&(e=5),e){let m=myalert.getElementsByTagName("h1")[0];return 1===e?m.innerHTML="不能有重复标题!":2===e?m.innerHTML="多选题请至少选择两个选项!":3===e?m.innerHTML="问卷选项不能少于两个！":4===e?m.innerHTML="问卷选项内容不能为空！":5===e?m.innerHTML="至少有一个题目！":6===e&&(m.innerHTML="截止时间不能早于当前时间！"),myalert.style.display="block",myblur.style.display="block",countdown=2,timeOutClose(),!1}return!0}function timeOutClose(){countdown>0?setTimeout("timeOutClose();",1e3):(myalert.style.display="none",myblur.style.display="none"),countdown--}btn_for_add.onclick=()=>{popup.style.display="block",myblur.style.display="block"},cancel.onclick=()=>{popup.style.display="none",myblur.style.display="none"},form.onsubmit=()=>!!check()&&numberQuestion(),op_name.onclick=()=>{createName("姓名","")},op_sno.onclick=()=>{createSno("学号","")},op_file.onclick=()=>{createFile("文件","")},op_radio.onclick=()=>{createSingleChoice("单选题","",0,[])},op_multipleChoice.onclick=()=>{createMultipleChoice("多选题","",0,[])},op_qnaire.onclick=()=>{createQuestionnaire("问卷题目","",["",""],!1)};let tmp_json=document.getElementById("collection").innerHTML,formData=JSON.parse(JSON.stringify(tmp_json)),formDataArr=[],formDataObj={},formDataLen=0;const reg=/(\d+)$/;let lastNum=1;function processFormData(){if(tmp_json){for(item in formData=JSON.parse(JSON.stringify(tmp_json=eval("("+tmp_json+")")))){let result=reg.exec(item);if(result){let num=result[1];num!=lastNum&&(formDataArr.push(formDataObj),formDataObj={});let key=item,value=formData[item];formDataObj[key]=value,lastNum=num}}formDataArr.push(formDataObj),formDataLen=formDataArr.length}}function createQuestion(){if(0===formDataLen){collectionTitle.value="文件收集",op_name.onclick(),op_sno.onclick(),op_file.onclick();return}collectionTitle.value=Object.values(formData)[0],collector.value=Object.values(formData)[1],deadline.value=Object.values(formData)[2],description.value=Object.values(formData)[3];for(let e=0;e<formDataLen;e++){formDataArr[e];let t=Object.keys(formDataArr[e]),l=Object.values(formDataArr[e]);if(-1!=t[0].indexOf("question_name"))createName(l[0],l[1]);else if(-1!=t[0].indexOf("question_sno"))createSno(l[0],l[1]);else if(-1!=t[0].indexOf("question_file"))createFile(l[0],l[1]);else if(-1!=t[0].indexOf("question_radio")){let n=l[l.length-1].toString().charCodeAt()-"A".charCodeAt();createSingleChoice(l[0],l[1],1,[n])}else if(-1!=t[0].indexOf("question_multipleChoice")){let a=0,i=[];for(let r=0;r<t.length;r++)-1!=t[r].indexOf("checked_mulans")&&(a++,i.push(l[r].toString().charCodeAt()-"A".charCodeAt()));createMultipleChoice(l[0],l[1],a,i)}else{let o=0,d=[];for(let c=0;c<t.length;c++)-1!=t[c].indexOf("qn_option")&&(o++,d.push(l[c]));let p="multiple"==l[l.length-1];createQuestionnaire(l[0],l[1],d,p)}}for(let s=0;s<formDataLen;s++){formDataArr[s];let m=Object.keys(formDataArr[s]),u=Object.values(formDataArr[s]),h=lis[s].querySelectorAll(".checked_topic_text");if(-1!=m[0].indexOf("question_file")){for(let f=0;f<m.length;f++)if(-1!=m[f].indexOf("checked_topic"))for(let g=0;g<h.length;g++)h[g].innerHTML==u[f]&&(h[g].previousSibling.checked="checked")}}}addLoadEvent(processFormData),addLoadEvent(createQuestion),addLoadEvent(deadline_limit);